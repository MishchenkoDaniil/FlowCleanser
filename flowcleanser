#!/bin/bash

# Initialize variables
OWNER=""
REPO=""
TOKEN=""

# Parse command line flags
while getopts "o:r:t:" opt; do
  case $opt in
    o) OWNER=$OPTARG;;
    r) REPO=$OPTARG;;
    t) TOKEN=$OPTARG;;
    \?) echo "Invalid option: -$OPTARG" >&2
        exit 1;;
  esac
done

# Check for necessary parameters
if [ -z "$OWNER" ] || [ -z "$REPO" ] || [ -z "$TOKEN" ]; then
  echo "Usage: $0 -o <owner> -r <repo> -t <token>"
  exit 1
fi

# Get list of workflows
WORKFLOWS=$(curl -s -H "Authorization: token $TOKEN" \
  "https://api.github.com/repos/$OWNER/$REPO/actions/workflows" | jq -c '.workflows[]')

for workflow in $WORKFLOWS; do
  WORKFLOW_NAME=$(echo $workflow | jq -r '.name')
  WORKFLOW_ID=$(echo $workflow | jq -r '.id')
  echo "Processing workflow: $WORKFLOW_NAME"

  # Get all runs of this workflow
  RUNS_URL="https://api.github.com/repos/$OWNER/$REPO/actions/workflows/$WORKFLOW_ID/runs"
  RUNS=$(curl -s -H "Authorization: token $TOKEN" $RUNS_URL | jq -c '.workflow_runs[]')

  for run in $RUNS; do
    RUN_ID=$(echo $run | jq -r '.id')
    # Delete the run
    DELETE_URL="https://api.github.com/repos/$OWNER/$REPO/actions/runs/$RUN_ID"
    echo "Deleting run $RUN_ID..."
    curl -X DELETE -H "Authorization: token $TOKEN" $DELETE_URL
  done
done
